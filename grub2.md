# Working with GRUB 2
- The GRUB 2 configuration file ```grub.cfg``` location:
  - BIOS machines: ```/boot/grub2/grub.cfg``` 
  - UEFI machines: ```/boot/efi/EFI/redhat/grub.cfg```
- The GRUB 2 configuration file ```grub.cfg``` generation:
  - created during installation
  - regenerated by running the ```grub2-mkconfig``` command
    - according to the template files in ```/etc/grub.d/```, and custom settings in the ```/etc/default/grub``` file.
  - automatically updated by ```grubby``` each time a new kernel is installed
- Edits of ```grub.cfg``` will be lost any time ``grub2-mkconfig`` is used to regenerate the file.
- Any manual changes to ``/etc/default/grub`` require rebuilding the ```grub.cfg``` file. 


## Configuring GRUB 2
### Menu Entries in /boot/grub2/grub.cfg
```
### BEGIN /etc/grub.d/10_linux ###
menuentry 'CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-957.el7.x86_64-advanced-d56e708b-c5a8-451e-b190-91b5659039b3' {
	load_video
	set gfxpayload=keep
	insmod gzio
	insmod part_msdos
	insmod xfs
	set root='hd0,msdos1'
	if [ x$feature_platform_search_hint = xy ]; then
	  search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  a0fe573a-f15f-4828-a286-c00617359ca1
	else
	  search --no-floppy --fs-uuid --set=root a0fe573a-f15f-4828-a286-c00617359ca1
	fi
	linux16 /vmlinuz-3.10.0-957.27.2.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet LANG=en_US.UTF-8
	initrd16 /initramfs-3.10.0-957.27.2.el7.x86_64.img
}
....
### END /etc/grub.d/10_linux ###
```


### /etc/default/grub
```
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet"
GRUB_DISABLE_RECOVERY="true"
```

Changes to ``/etc/default/grub`` require rebuilding the ``grub.cfg`` file:
- On BIOS-based machines:
  ```
  $ grub2-mkconfig -o /boot/grub2/grub.cfg
  ```
- On UEFI-based machines:
  ```
  $ grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg
  ```


### /boot/grub2/grubenv
```
# GRUB Environment Block
saved_entry=CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)
```


### grubby
The grubby tool can be used to read information from, and make persistent changes to, the `grub.cfg` file.
- To list all the kernel menu entries:
  ```
  $ grubby --info=ALL
  index=0
  kernel=/boot/vmlinuz-3.10.0-957.27.2.el7.x86_64
  args="ro crashkernel=auto rd.lvm.lv=cl_rh7/root rd.lvm.lv=cl_rh7/swap rhgb quiet LANG=en_US.UTF-8"
  root=/dev/mapper/cl_rh7-root
  initrd=/boot/initramfs-3.10.0-957.27.2.el7.x86_64.img
  title=CentOS Linux (3.10.0-957.27.2.el7.x86_64) 7 (Core)
  ....
  ```
- To view the GRUB 2 menu entry for a specific kernel:
  ```
  $ grubby --info /boot/vmlinuz-3.10.0-514.el7.x86_64
  ```
- To find out the file name of the default kernel:
  ```
  $ grubby --default-kernel
  /boot/vmlinuz-3.10.0-957.27.2.el7.x86_64
  ```
- To find out the index number of the default kernel:
  ```
  $ grubby --default-index
  0
  ```
- Changing the default boot entry persistently:
  ```
  $ grubby --set-default /boot/vmlinuz-3.10.0-514.el7.x86_64
  ```
- To add and remove arguments from a kernel, e.q.:
  ```
  $ grubby --remove-args="rhgb quiet" --args=console=ttyS0,38400 --update-kernel /boot/vmlinuz-3.10.0-957.27.2.el7.x86_64
  ```
- Changinig a kernel argument, e.q.:
  ```
  $ grubby --args=vconsole.font=latarcyrheb-sun32 --update-kernel /boot/vmlinuz-3.10.0-957.27.2.el7.x86_64
  ```


### grub2-set-default
Changing the default boot entry:
```
$ grub2-set-default <index number>
``` 


## Reinstalling GRUB 2
- Upgrading from the previous version of GRUB.
- Reinstalling GRUB 2 returns control to the desired operating system in the multi-boot environment.
- Adding the boot information to another drive.
  
### Reinstall GRUB 2 if files are not corrupted
Update information and restore missing files of boot loader.
- On BIOS-based machines:
  ```
  $ grub2-install /dev/sda
  ```
- On UEFI-based machines:
  ```
  $ yum reinstall grub2-efi shim
  ```

## Reinstall GRUB 2 if files are corrupted
Remove the configuration files and reinstall of GRUB 2 files.
1. Remove configuration files:
   ```
   $ rm /etc/grub.d/*
   $ rm /etc/sysconfig/grub 
   ```
2. Reinstall configuration files:
   - On BIOS-based machines:
     ```
     $ yum reinstall grub2-tools
     ``` 
   - On UEFI-based machines:
     ```
     $ yum reinstall grub2-efi shim grub2-tools
     ```
3. Rebuild the ```grub.cfg```:
   - On BIOS-based machines:
     ```
     $ grub2-mkconfig -o /boot/grub2/grub.cfg
     ```
   - On UEFI-based machines:
     ```
     $ grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg
     ```   
4. Reinstall GRUB 2 on the ``/boot/`` partition:
   - On BIOS-based machines:
     ```
     $ grub2-install /dev/sda
     ```
   - On UEFI-based machines:
     ```
     $ yum reinstall grub2-efi shim
     ```   


## Upgrading to GRUB 2     
1. Remove GRUB legacy package:
   ```
   $ yum remove grub
   ``` 
2. Install GRUB 2 package:
   ```
   $ yum install grub2
   ```
3. Generating the GRUB 2 configuration files:
   1. Install the GRUB 2 files to the ``/boot/grub/`` directory of system disk (/dev/sda):
      ```
      $ grub2-install --grub-setup=/bin/true /dev/sda
      ``` 
   2. Generate the ``grub.cfg``: 
      - On BIOS-based machines:
        ```
        $ grub2-mkconfig -o /boot/grub2/grub.cfg
        ```
      - On UEFI-based machines:
        ```
        $ grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg
        ``` 
4. Replace GRUB legacy bootloader by reinstall GRUB 2
   - On BIOS-based machines:
     ```
     $ grub2-install /dev/sda
     ```
   - On UEFI-based machines:
     ```
     $ yum reinstall grub2-efi shim
     ```

## Debug Booting with GRUB 2
Modify GRUB kernel parameters to start a minimal shell for debuging.

### Booting to Rescue Mode (Single User Mode)
- mount all local filesystem
- start some import system services
- no activate network 
- kernel parmeter: ``systemd.target=rescue.target``

### Booting to Emergency Mode
- mount root filesystem only for read
- only few essential serices
- no activate network
- kernel parmeter: ``systemd.unit=emergency.target``

### Booting to the Debug Shell
- use ``systemctl`` commands for debug
- kernel parmeter: ``systemd.deubg-shell``